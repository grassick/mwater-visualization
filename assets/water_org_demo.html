<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Water.org Visualization Demo</title>
        <link rel="stylesheet" type="text/css" href="css/libs.css">
        <link rel="stylesheet" type="text/css" href="css/index.css">
        <style>
            html, body { height: 100%;}
        </style>
    </head>
    <body>
        <script src="js/libs.js" type="text/javascript"></script>
        <script src="js-yaml.min.js" type="text/javascript"></script>
        <script src="js/mwater-visualization.js" type="text/javascript"></script>
        <div class="container-fluid" style="height: 100%">
          <div class="row" style="height: 100%">
            <div id="dashboard_view" class="col-xs-8" style="padding-top: 10px; height: 100%; overflow: auto;"></div>
            <div id="dashboard_designer" class="col-xs-4" style="border-left: solid 3px #AAA; height: 100%; padding-top: 10px"></div>
          </div>
        </div>

        <script type="text/javascript">

var design = {
  "items": { }
}

/* First get the schema */
$.get("water_org_schema.yaml", function(schemaYaml) {
    var DashboardComponent = require('mwater-visualization').DashboardComponent;
    var WidgetFactory = require('mwater-visualization').WidgetFactory;
    var Schema = require('mwater-visualization').Schema;
    var CachingDataSource = require('mwater-visualization').CachingDataSource;

    // Load the schema
    var schema = new Schema();
    schemaJson = jsyaml.safeLoad(schemaYaml);
    schema.loadFromJSON(schemaJson);

    // Create the data source
    var dataSource = new CachingDataSource({
        perform: function(query, cb) {
            // console.log(JSON.stringify(query));
            $.getJSON("http://dev-portal.water.org/index.php/visualization?query=" + encodeURIComponent(JSON.stringify(query)), function(rows) {
                cb(null, rows);
            }).fail(function(xhr) {
                console.error(xhr.responseText);
                cb(new Error(xhr.responseText));
            });
        }
    });

    // Create the widget factory
    var widgetFactory = new WidgetFactory({ schema: schema, dataSource: dataSource });

    // Called to update the design and re-render
    function updateDesign(newDesign) {
      design = newDesign;
      render();
    }

    // Render the dashboard
    function render() {
      var dashboardElem = React.createElement(DashboardComponent, {
        design: design,
        widgetFactory: widgetFactory,
        onDesignChange: updateDesign
      });

      React.render(dashboardElem, document.getElementById("dashboard_view"))
    }

    render();
});

        </script>
    </body>
</html>
